var cnv,ctx,cnvWidth,cnvHeight,mouse,cam,cellSize=50,Speed=500,dirPress=[,,,,],Objects=[];document.addEventListener("keydown",keyDownHandler,!1),document.addEventListener("keyup",keyUpHandler,!1);function onLoad(){cnv=document.getElementById("cnvs"),ctx=cnv.getContext("2d"),cnv.addEventListener("mousemove",mouseMove,!1),cnv.addEventListener("mousedown",mouseDown,!1),cnv.addEventListener("mouseup",mouseUp,!1),cnvWidth=cnv.width,cnvHeight=cnv.height,ctx.translate(Math.round(cnvWidth/2),Math.round(cnvHeight/2)),Objects.push(new Player(0,0,"Player1",cellSize,cellSize,"#090")),Objects.push(new Player(50,100,"Player2",cellSize,cellSize,"#900")),mouse=new Mouse,cam=new Camera(Objects[0],Objects);for(var a=0;5e4>a;a++){let b=getUniqueAlignedPos();Objects.push(new Box(b.x,b.y,"Box",cellSize,cellSize,"#222"))}}function mouseMove(a){mouse.pos.Set(a.pageX-8-cnvWidth/2,a.pageY-50-cnvHeight/2)}function mouseDown(){mouse.Press();for(var b=0;b<Objects.length;b++)if(posIntersection(mouse.pos,Objects[b].pos)&Objects[b].id!=cam.target.id){mouse.SetDragObj(Objects[b]);break}}function mouseUp(){mouse.Up(),mouse.DragObj&&mouse.DragObj.AlignToGrid(),mouse.DragRelease()}function keyDownHandler(a){let b=1.2;39==a.keyCode&&(dirPress[0]=!0),37==a.keyCode&&(dirPress[1]=!0),38==a.keyCode&&(dirPress[2]=!0),40==a.keyCode&&(dirPress[3]=!0),49==a.keyCode&&cam.setTarget(findObjecByType("Player1")),50==a.keyCode&&cam.setTarget(findObjecByType("Player2")),51==a.keyCode&&cam.setTarget(cam),187==a.keyCode&&cam.ScaleUp(b),189==a.keyCode&&cam.ScaleDown(b)}function keyUpHandler(a){39==a.keyCode&&(dirPress[0]=!1),37==a.keyCode&&(dirPress[1]=!1),38==a.keyCode&&(dirPress[2]=!1),40==a.keyCode&&(dirPress[3]=!1)}function Render(){ctx.clearRect(-cnvWidth/2,-cnvHeight/2,cnvWidth,cnvHeight);for(var b=Objects.length-1;0<=b;b--)objectOnScreen(Objects[b].pos)&&Objects[b].Draw();ctx.fillStyle="Red",DrawText(-cnvWidth/2+5,-cnvHeight/2+25,"Object displey:"+objectOnScreenCount())}function Update(a){dirPress[0]&&cam.moveRight(Speed*a),dirPress[1]&&cam.moveLeft(Speed*a),dirPress[2]&&cam.moveUp(Speed*a),dirPress[3]&&cam.moveDown(Speed*a),cam.Update(),mouse.DragObj&&mouse.DragObj.pos.SetV2(new Vector2(mouse.pos.x-cellSize/2,mouse.pos.y-cellSize/2));for(var b=0;b<Objects.length;b++)Objects[b].Update(Speed/100)}let now,last=performance.now(),step=1/60,dt=0,frame=()=>{for(now=performance.now(),dt+=Math.min(1,(now-last)/1e3);dt>step;)dt-=step,Update(step);last=now,Render(dt),requestAnimationFrame(frame)};requestAnimationFrame(frame);function mathTest(){console.log("mathTest")}function getRnd(a,b){return Math.floor(Math.random()*(b-a))+a}class Vector2{constructor(a,b){this.x=a,this.y=b}Zero(){return new Vector2(0,0)}SetV2(a){this.x=a.x,this.y=a.y}Set(a,b){this.x=a,this.y=b}Add(a,b){this.x+=a,this.y+=b}AddV2(a){this.x+=a.x,this.y+=a.y}MulV2(a){this.x*=a.x,this.y*=a.y}DivV2(a){this.x/=a.x,this.y/=a.y}Div(a,b){this.x/=a,this.y/=b}Mul(a,b){this.x*=a,this.y*=b}DecV2(a){return new Vector2(this.x-a.x,this.y-a.y)}V2Equals(a){return!!(this.x==a.x&this.y==a.y)}}function posIntersection(a,b){return!!(a.x>=b.x&a.x<=b.x+cellSize&(a.y<=b.y+cellSize&a.y>=b.y))}function objectOnScreen(a){return!!(a.x>-cnvWidth/2-cellSize&a.x<cnvWidth/2+cellSize&a.y>-cnvHeight/2-cellSize&a.y<cnvHeight/2+cellSize)}function objectOnScreenCount(){let a=0;for(var b=0;b<Objects.length;b++)objectOnScreen(Objects[b].pos)&&a++;return a}function AlignToGrid(a){let b=Math.round(a.x/cellSize)*cellSize,c=Math.round(a.y/cellSize)*cellSize;return new Vector2(b,c)}function getUniqueAlignedPos(){let a=!0,b=new Vector2().Zero();do{a=!0,b.x=getRnd(10*-cnvWidth,10*cnvWidth),b.y=getRnd(10*-cnvHeight,10*cnvHeight),b=AlignToGrid(b);for(var c=0;c<Objects.length;c++)if(b.V2Equals(Objects[c].pos)){a=!1;break}}while(!a);return b}function objectsIntersection(){}function getUniquePos(){let a=!0,b=new Vector2().Zero();do{a=!0,b.x=getRnd(10*-cnvWidth,10*cnvWidth),b.y=getRnd(10*-cnvHeight,10*cnvHeight);for(var c=0;c<Objects.length;c++)if(posIntersection(b,Objects[c].pos)){a=!1;break}}while(!a);return b}function baseTest(){console.log("baseTest")}class baseObject{constructor(a,b,c,d,f){this.pos=new Vector2(a,b),this.type=c,this.width=d,this.height=f,this.id=getRnd(0,1e5)}moveRight(a){this.pos.Add(a,0)}moveLeft(a){this.pos.Add(-a,0)}moveUp(a){this.pos.Add(0,-a)}moveDown(a){this.pos.Add(0,a)}Draw(a,b,c){DrawRect(this.pos.x,this.pos.y,a,b,c)}Update(){}AlignToGrid(){this.pos.x=Math.round(this.pos.x/cellSize)*cellSize,this.pos.y=Math.round(this.pos.y/cellSize)*cellSize}}class Player extends baseObject{constructor(a,b,c,d,f,g){super(a,b,c,d,f),this.color=g}Draw(){DrawRect(this.pos.x,this.pos.y,this.width,this.height,this.color)}Update(){}}class Box extends baseObject{constructor(a,b,c,d,f,g){super(a,b,c,d,f),this.width=d,this.height=f,this.color=g}Update(){}Draw(){DrawRect(this.pos.x,this.pos.y,this.width,this.height,this.color)}}class Mouse extends baseObject{constructor(){super(0,0,"Mouse"),this.DragObj=void 0,this.mousePress=!1}SetDragObj(a){this.DragObj=a}DragRelease(){this.DragObj=void 0}Press(){this.mousePress=!0}Up(){this.mousePress=!1}IsPress(){return this.mousePress}Update(){}Draw(){}}class Camera extends baseObject{constructor(a,b){super(0,0,"Camera"),this.target=a,this.objects=b,this.deltaPos=new Vector2().Zero()}Update(){for(var a=0;a<this.objects.length;a++)this.id==this.objects[a].id|this.target.id==this.objects[a].id||this.objects[a].pos.AddV2(this.deltaPos);this.deltaPos=new Vector2().Zero()}setTarget(a){this.deltaPos=this.pos.DecV2(a.pos),this.target=this,this.Update(),this.target=a,this.deltaPos=new Vector2().Zero()}Draw(){}moveRight(a){this.deltaPos.x=-a}moveLeft(a){this.deltaPos.x=a}moveUp(a){this.deltaPos.y=a}moveDown(a){this.deltaPos.y=-a}ScaleUp(a){Speed*=a,cellSize*=a;for(var b=0;b<Objects.length;b++)Objects[b].width*=a,Objects[b].height*=a,Objects[b].pos.Mul(a,a)}ScaleDown(a){Speed/=a,cellSize/=a;for(var b=0;b<Objects.length;b++)Objects[b].width/=a,Objects[b].height/=a,Objects[b].pos.Div(a,a)}}function findObjecByType(a){for(var b=0;b<Objects.length;b++)if(Objects[b].type===a){return Objects[b]}}function findObjecById(a){for(var b=0;b<Objects.length;b++)if(Objects[b].id===a){return Objects[b]}}function DrawTest(){console.log("DrawTest")}function DrawRect(a,b,c,d,f){ctx.fillStyle=f,ctx.fillRect(a,b,c,d)}function DrawText(a,b,c){ctx.font="25px serif",ctx.fillText(c,a,b)}